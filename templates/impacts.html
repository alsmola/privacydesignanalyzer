{% extends "layout.html" %}
{% block body %}
    <script type="text/javascript">
    function modifyImpactResult(result) {
        if (result['success']) {

        } else {
            $('.error').html(result['message']);
        }
    }
    
    $(document).ready(function () {
        $('#impacts').addClass('selected');
        
        $('.effects').each(function() {
            var chosen = false;
            $(this).find('.effect input').each(function () {
               if ($(this).attr('checked')) {
                   chosen = true;
               }
            });
            if (!chosen) {
                $(this).find('.neutral').attr('checked', 'true');
            }
        });
        
        $('.effect input').live('change', function () {
            var app_id = $(this).parents('.impacts').attr('id').split('-')[1];
            var mitigation_id = $(this).parents('.impact-row').attr('id').split('-')[1];
            var goal_id = $(this).parents('.effects').siblings('.mitigation').attr('id').split('-')[1];
            var effect = $(this).val();
            
            $.post('/impact', 
                {app_id:app_id, mitigation_id: mitigation_id, goal_id: goal_id, effect: effect},
                function(data) {
                    modifyImpactResult(data);
                }
            ).error(function(xhr, ajaxOptions, thrownError) { error(thrownError) } );
        });
    });
    </script>

    <div class="impacts" id="app-{{app_id}}">
        {% for mitigation in mitigations %}
            <div class="impact-row" id="mitigation-{{mitigation.id}}">
                    <div class="mitigation">
                        When <span class="variable-text">{{mitigation.disclosure.from_actor.name}}</span>
                        discloses <span class="variable-text">{{mitigation.disclosure.datum.name}}</span>
                        to <span class="variable-text">{{mitigation.disclosure.to_actor.name}}</span>, and the design alternative is
                        <span class="variable-text">{{mitigation.category}}</span>,
                    </div>
                    {% for actor in actors %}
                        {% for goal in actor.goals %}    
                    <form class="effects-form" id="goal-{{goal.id}}">
                        <div class="actor-goal">
                            ...<span class="variable-text">{{actor.name}}</span> goal of <span class="variable-text">{{goal.name}}</span> is:
                        </div>
                        <ul class="effects">
                            <li class="effect"><input type="radio" name="effects" class="support" value="support" {{checked(mitigation.id, goal.id, 'support')}}/><label>Supported</label></li>
                            <li class="effect"><input type="radio" name="effects" class="neutral" value="neutral" {{checked(mitigation.id, goal.id, 'neutral')}})}}/><label>Unaffected</label></li>
                            <li class="effect"><input type="radio" name="effects" class="harm" value="harm"  {{checked(mitigation.id, goal.id, 'harm')}}/><label>Harmed</label></li>
                        </ul>
                    </form>
                        {% endfor %}
                    {% endfor %}
                    <div class="clear"></div>
                </div>
        {% endfor %}
    </div>
    
    <div id="nav">
        <a class="prev" href="/mitigations?app_id={{ app_id }}">&lt; Prev (Mitigations)</a>
        <a class="next" href="/results?app_id={{ app_id }}">Next (Results) &gt;</a>
    </div>
{% endblock %}

{% macro checked(mitigation_id, goal_id, effect) %}
    {% for i in impacts %}
        {% if i.mitigation_id == mitigation_id and i.goal_id == goal_id and i.effect == effect %}
            checked="true"
        {% endif %}
    {% endfor %}
{% endmacro %}

